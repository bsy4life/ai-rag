<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/png" sizes="192x192" href="/frontend/icon/icon-192.png">
  <link rel="apple-touch-icon" href="/frontend/icon/icon-192.png">
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <title>SanShinAI</title>
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    @media (max-width: 768px) {
      #sidebar { width: 60vw !important; }
      #main-content { width: 100vw !important; margin-left: 0 !important; }
      #chat-box div { word-break: break-word; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">

  <!-- PWA å®‰è£æŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼Œé è¨­éš±è—ï¼‰ -->
  <div class="fixed top-4 right-4 z-50">
    <button id="install-btn"
      style="display:none;"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow transition"
    >
      å®‰è£æ¡Œé¢æ‡‰ç”¨ç¨‹å¼
    </button>
  </div>

  <!-- ========== ç™»å…¥ç•«é¢ ========== -->
  <div id="login-page" class="h-screen flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-6 rounded shadow w-80">
      <h2 class="text-xl font-bold dark:text-gray-100 mb-4">è«‹ç™»å…¥</h2>
      <input id="login-account"
             class="w-full mb-2 p-2 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
             placeholder="å¸³è™Ÿ"
             type="text" />
      <input id="login-password"
             class="w-full mb-4 p-2 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
             placeholder="å¯†ç¢¼"
             type="password" />
      <button onclick="login()"
              class="w-full bg-blue-500 dark:bg-blue-700 text-white py-2 rounded hover:bg-blue-600 dark:hover:bg-blue-800 transition">
        ç™»å…¥
      </button>
      <p id="login-error" class="text-red-500 dark:text-red-400 text-sm mt-2 hidden">
        ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿæˆ–å¯†ç¢¼
      </p>
    </div>
  </div>

  <!-- ========== èŠå¤©ä¸»ç•«é¢ ========== -->
  <div id="chat-page" class="hidden h-screen">
    <!-- å´é‚Šæ¬„é®ç½©ï¼ˆbackdropï¼‰ï¼Œè¡Œå‹•ç‰ˆé»æ“Šå¯é—œé–‰å´é‚Šæ¬„ -->
    <div id="sidebar-backdrop"
         class="hidden fixed inset-0 bg-black bg-opacity-50 z-20"
         onclick="closeSidebar()"></div>

    <div class="flex h-full">
      <!-- å´é‚Šæ¬„ Drawer -->
      <div id="sidebar"
           class="fixed inset-y-0 left-0 transform -translate-x-full w-64 h-full bg-white dark:bg-gray-800 p-4 border-r dark:border-gray-700 overflow-y-auto transition-transform duration-300 z-30 md:static md:translate-x-0 md:w-64 md:border-r">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-bold dark:text-gray-100">å°è©±åˆ—è¡¨</h2>
          <!-- è¡Œå‹•ç‰ˆè‹¥ç„¡ä»»ä½•å°è©±ï¼Œéš±è—ã€Œï¼‹ æ–°å°è©±ã€æŒ‰éˆ• -->
          <button id="mobile-new-chat-btn"
                  class="text-blue-500 dark:text-blue-300 hover:underline text-sm"
                  onclick="newChat()">
            ï¼‹ æ–°å°è©±
          </button>
        </div>
        <div class="space-y-2" id="chat-list">
          <!-- JS æœƒåœ¨é€™è£¡å‹•æ…‹æ’å…¥å°è©±æŒ‰éˆ• -->
        </div>
      </div>

      <!-- ä¸»å…§å®¹å€ -->
      <div id="main-content" class="flex-1 flex flex-col">
        <!-- ========= èª¿æ•´å¾Œçš„ã€Œæ¨™é¡Œåˆ—ã€é–‹å§‹ ========= -->
        <div class="flex items-center justify-between p-4 border-b dark:border-gray-700 bg-white dark:bg-gray-800 sticky top-0 z-10">
          <!-- å·¦å´ï¼šâ˜° åˆ‡æ›å´é‚Šæ¬„ -->
          <div class="flex items-center">
            <button id="sidebar-toggle"
              class="md:hidden bg-gray-800 dark:bg-gray-200 text-white dark:text-gray-800
                p-2 w-10 h-10 flex items-center justify-center
                rounded-lg hover:bg-gray-700 dark:hover:bg-gray-300
                transition text-2xl"
              title="åˆ‡æ›å´é‚Šæ¬„">
              â˜°
            </button>
          </div>
          <!-- ä¸­é–“ï¼šæ¨™é¡Œ + å¤œé–“æ¨¡å¼åˆ‡æ› -->
          <div class="flex items-center space-x-2">
            <h1 class="text-xl font-bold dark:text-gray-100">AI åŠ©ç†</h1>
            <button id="theme-toggle"
                    class="text-2xl text-gray-600 dark:text-gray-200 hover:text-gray-800 dark:hover:text-white transition"
                    title="åˆ‡æ›å¤œé–“ï¼æ—¥é–“æ¨¡å¼">
              ğŸŒ™
            </button>
          </div>
          <!-- å³å´ï¼šä½¿ç”¨è€…ä¸‹æ‹‰é¸å–® -->
          <div class="relative inline-block text-left">
            <button id="user-dropdown-btn"
                    class="flex items-center text-gray-700 dark:text-gray-200 text-sm hover:underline"
                    onclick="toggleDropdown()">
              <span class="mr-1">ğŸ‘¤</span>
              <span id="user-info-dropdown"></span>
              <span class="ml-1">â–¼</span>
            </button>
            <div id="user-dropdown"
                 class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded shadow z-20">
              <button class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700"
                      onclick="toggleAdmin()">å¸³è™Ÿç®¡ç†</button>
              <button class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700"
                      onclick="changeOwnPassword()">ä¿®æ”¹å¯†ç¢¼</button>
              <button class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100 dark:hover:bg-gray-700 text-red-500"
                      onclick="logout()">ç™»å‡º</button>
            </div>
          </div>
        </div>
        <!-- ========= èª¿æ•´å¾Œçš„ã€Œæ¨™é¡Œåˆ—ã€çµæŸ ========= -->

        <!-- èŠå¤©è¨Šæ¯å€ (è¨Šæ¯æ³¡æ³¡ç”± JS å‹•æ…‹æ’å…¥) -->
        <div id="chat-box"
             class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 dark:bg-gray-900">
        </div>

        <!-- è¼¸å…¥åˆ— -->
        <div class="p-4 border-t dark:border-gray-700 flex items-center bg-white dark:bg-gray-800">
          <input id="input"
                 class="flex-1 border rounded p-2 bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
                 placeholder="è¼¸å…¥å•é¡Œ..." type="text" />
          <button onclick="sendMessage()"
                  class="ml-2 bg-blue-500 dark:bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-600 dark:hover:bg-blue-800 transition">
            é€å‡º
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- ========== å¸³è™Ÿç®¡ç†é é¢ ========== -->
  <div id="admin-page" class="hidden p-6 bg-gray-50 dark:bg-gray-900">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold dark:text-gray-100">å¸³è™Ÿç®¡ç†</h2>
      <div class="space-x-2">
        <!-- 1. åŠ ä¸Š id="create-user-btn"ï¼Œ 2. é è¨­åŠ  hidden éš±è—æŒ‰éˆ• -->
        <button id="create-user-btn"
                class="hidden text-sm text-green-600 dark:text-green-400 border border-green-600 dark:border-green-400 px-2 py-1 rounded hover:bg-green-50 dark:hover:bg-gray-700"
                onclick="openCreateModal()">
          â• æ–°å¢ä½¿ç”¨è€…
        </button>
        <button class="text-sm text-gray-500 dark:text-gray-300"
                onclick="closeAdmin()">
          é—œé–‰
        </button>
      </div>
    </div>

    <!-- â—†â—†â—† åœ¨é€™è£¡åŠ ä¸Š overflow-x-auto â—†â—†â—† -->
    <div class="overflow-x-auto mb-4">
      <!-- â—†â—†â—† ä¿®æ”¹ table class ç‚º min-w-full table-auto whitespace-nowrap â—†â—†â—† -->
      <table class="min-w-full table-auto whitespace-nowrap border dark:border-gray-700">
        <thead>
          <tr class="bg-gray-200 dark:bg-gray-800">
            <!-- â—†â—†â—† å°‡ p-2 æ”¹ç‚º px-2 py-1ï¼Œä¸¦åŠ ä¸Š text-left â—†â—†â—† -->
            <th class="border px-2 py-1 dark:border-gray-600 dark:text-gray-100 text-left">å¸³è™Ÿ</th>
            <th class="border px-2 py-1 dark:border-gray-600 dark:text-gray-100 text-left">å§“å</th>
            <th class="border px-2 py-1 dark:border-gray-600 dark:text-gray-100 text-left">éƒ¨é–€</th>
            <th class="border px-2 py-1 dark:border-gray-600 dark:text-gray-100 text-left">è§’è‰²</th>
            <th class="border px-2 py-1 dark:border-gray-600 dark:text-gray-100 text-left">æ“ä½œåŠŸèƒ½</th>
          </tr>
        </thead>
        <tbody id="user-table" class="bg-white dark:bg-gray-800">
          <!-- JS æœƒåœ¨é€™è£¡å‹•æ…‹æ’å…¥ä½¿ç”¨è€…è³‡æ–™åˆ— -->
        </tbody>
      </table>
    </div>
    <!-- â˜…â˜…â˜… overflow-x-auto å®¹å™¨çµæŸ â˜…â˜…â˜… -->

    <!-- åˆ†é å€ -->
    <div id="pagination" class="flex justify-center items-center gap-4"></div>

    <!-- æ–°å¢ä½¿ç”¨è€… Modal -->
    <div id="create-modal"
         class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
      <div class="bg-white dark:bg-gray-800 p-6 rounded shadow w-96 space-y-3">
        <h2 class="text-lg font-bold dark:text-gray-100">æ–°å¢ä½¿ç”¨è€…</h2>
        <input id="modal-acc"
               placeholder="å¸³è™Ÿ"
               class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
        <input id="modal-pw1"
               placeholder="å¯†ç¢¼"
               type="password"
               class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
        <input id="modal-pw2"
               placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼"
               type="password"
               class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />
        <input id="modal-name"
               placeholder="å§“å"
               class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />

        <!-- éƒ¨é–€ä¸‹æ‹‰ï¼Œä¿æŒåŸæœ¬ max-h-60 overflow-auto -->
        <select id="modal-dept" class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 max-h-60 overflow-auto">
          <option value="" disabled selected>é¸æ“‡éƒ¨é–€</option>
          <option value="è‘£äº‹é•·å®¤">è‘£äº‹é•·å®¤</option>
          <option value="ç¸½ç¶“ç†å®¤">ç¸½ç¶“ç†å®¤</option>
          <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
          <option value="è²¿æ˜“èª²">è²¿æ˜“èª²</option>
          <option value="æ¡è³¼">æ¡è³¼</option>
          <option value="ç©ºå£“ç”¢å“ç¾¤">ç©ºå£“ç”¢å“ç¾¤</option>
          <option value="æ²¹å£“ç”¢å“ç¾¤">æ²¹å£“ç”¢å“ç¾¤</option>
          <option value="æ­¢æ´©ç”¢å“ç¾¤">æ­¢æ´©ç”¢å“ç¾¤</option>
          <option value="å°åŒ—ç‡Ÿæ¥­æ‰€">å°åŒ—ç‡Ÿæ¥­æ‰€</option>
          <option value="å°ä¸­ç‡Ÿæ¥­æ‰€">å°ä¸­ç‡Ÿæ¥­æ‰€</option>
          <option value="å°å—ç‡Ÿæ¥­æ‰€">å°å—ç‡Ÿæ¥­æ‰€</option>
          <option value="é«˜é›„ç‡Ÿæ¥­æ‰€">é«˜é›„ç‡Ÿæ¥­æ‰€</option>
          <option value="æ¹–å…§å» ">æ¹–å…§å» </option>
          <option value="æ¹–å…§å» è£½é€ èª²">æ¹–å…§å» è£½é€ èª²</option>
          <option value="æ¹–å…§å» æ¥­å‹™èª²">æ¹–å…§å» æ¥­å‹™èª²</option>
          <option value="å„²é‹æ‰€">å„²é‹æ‰€</option>
        </select>

        <select id="modal-role"
                class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <div class="flex justify-end space-x-2 pt-2">
		  <button class="px-4 py-1 rounded bg-green-600 dark:bg-green-800 text-white hover:bg-green-700 dark:hover:bg-green-900"
                  onclick="submitCreateUser()">æ–°å¢</button>
          <button class="px-4 py-1 rounded bg-gray-300 dark:bg-gray-600 dark:text-gray-100 hover:bg-gray-400 dark:hover:bg-gray-500"
                  onclick="closeCreateModal()">å–æ¶ˆ</button>

        </div>
      </div>
    </div>

    <!-- ç·¨è¼¯å€‹äººè³‡æ–™ Modal -->
    <div id="edit-profile-modal"
         class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
      <div class="bg-white dark:bg-gray-800 p-6 rounded w-96 space-y-3">
        <h2 class="font-bold text-lg dark:text-gray-100">ä¿®æ”¹å€‹äººè³‡æ–™</h2>
        <input id="edit-name"
               placeholder="å§“å"
               class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" />

        <!-- éƒ¨é–€ä¸‹æ‹‰ï¼Œä¿æŒåŸæœ¬ max-h-60 overflow-auto -->
        <select id="edit-dept" class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 max-h-60 overflow-auto">
          <option value="è‘£äº‹é•·å®¤">è‘£äº‹é•·å®¤</option>
          <option value="ç¸½ç¶“ç†å®¤">ç¸½ç¶“ç†å®¤</option>
          <option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option>
          <option value="è²¿æ˜“èª²">è²¿æ˜“èª²</option>
          <option value="æ¡è³¼">æ¡è³¼</option>
          <option value="ç©ºå£“ç”¢å“ç¾¤">ç©ºå£“ç”¢å“ç¾¤</option>
          <option value="æ²¹å£“ç”¢å“ç¾¤">æ²¹å£“ç”¢å“ç¾¤</option>
          <option value="æ­¢æ´©ç”¢å“ç¾¤">æ­¢æ´©ç”¢å“ç¾¤</option>
          <option value="å°åŒ—ç‡Ÿæ¥­æ‰€">å°åŒ—ç‡Ÿæ¥­æ‰€</option>
          <option value="å°ä¸­ç‡Ÿæ¥­æ‰€">å°ä¸­ç‡Ÿæ¥­æ‰€</option>
          <option value="å°å—ç‡Ÿæ¥­æ‰€">å°å—ç‡Ÿæ¥­æ‰€</option>
          <option value="é«˜é›„ç‡Ÿæ¥­æ‰€">é«˜é›„ç‡Ÿæ¥­æ‰€</option>
          <option value="æ¹–å…§å» ">æ¹–å…§å» </option>
          <option value="æ¹–å…§å» è£½é€ èª²">æ¹–å…§å» è£½é€ èª²</option>
          <option value="æ¹–å…§å» æ¥­å‹™èª²">æ¹–å…§å» æ¥­å‹™èª²</option>
          <option value="å„²é‹æ‰€">å„²é‹æ‰€</option>
        </select>

        <div class="flex justify-end space-x-2">
          <button class="px-4 py-1 bg-blue-600 dark:bg-blue-800 text-white rounded hover:bg-blue-700 dark:hover:bg-blue-900"
                  onclick="submitEditProfile()">å„²å­˜</button>
          <button class="px-4 py-1 bg-gray-300 dark:bg-gray-600 dark:text-gray-100 rounded hover:bg-gray-400 dark:hover:bg-gray-500"
                  onclick="closeProfileModal()">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ä¿®æ”¹å¯†ç¢¼ Modalï¼ˆå¿…é ˆæ”¾åœ¨æœ€å¤–å±¤ï¼‰ ========== -->
  <div id="password-modal"
       class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded shadow w-80 space-y-4">
      <h2 class="text-lg font-bold dark:text-gray-100">ä¿®æ”¹å¯†ç¢¼</h2>
      <input id="pw1"
             class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
             placeholder="æ–°å¯†ç¢¼"
             type="password" />
      <input id="pw2"
             class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"
             placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼"
             type="password" />
      <div class="flex justify-end space-x-2">
        <button onclick="submitPasswordChange()"
                class="px-4 py-1 rounded bg-blue-500 dark:bg-blue-700 text-white hover:bg-blue-600 dark:hover:bg-blue-800 transition">
          ç¢ºèª
        </button>
        <button onclick="closePasswordModal()" class="px-4 py-1 rounded bg-gray-300 dark:bg-gray-600 dark:text-gray-100 hover:bg-gray-400 dark:hover:bg-gray-500">
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <!-- ========== ä¿®æ”¹ä½¿ç”¨è€…æ¬Šé™ Modalï¼ˆæ”¾åœ¨æœ€å¤–å±¤ï¼‰ ========== -->
  <div id="edit-role-modal"
       class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white dark:bg-gray-800 p-6 rounded w-80 space-y-3">
      <h2 class="font-bold text-lg dark:text-gray-100">ä¿®æ”¹ä½¿ç”¨è€…æ¬Šé™</h2>
      <select id="edit-role"
              class="w-full border p-2 rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
        <option value="user">user</option>
        <option value="admin">admin</option>
      </select>
      <div class="flex justify-end space-x-2">
        <button class="px-4 py-1 bg-green-600 dark:bg-green-800 text-white rounded hover:bg-green-700 dark:hover:bg-green-900"
                onclick="submitEditRole()">å„²å­˜</button>
        <button class="px-4 py-1 bg-gray-300 dark:bg-gray-600 dark:text-gray-100 rounded hover:bg-gray-400 dark:hover:bg-gray-500"
                onclick="closeRoleModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- è¼‰å…¥å¤–éƒ¨ JS -->
  <script src="script.js"></script>
<script>
  let deferredPrompt = null; // <-- åªå®£å‘Šä¸€æ¬¡

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('install-btn').style.display = 'block';
  });

  document.getElementById('install-btn').addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        console.log('ç”¨æˆ¶å·²æ¥å—å®‰è£');
      }
      deferredPrompt = null;
      document.getElementById('install-btn').style.display = 'none';
    }
  });
</script>


<!-- ğŸ“± å®‰è£æç¤ºå€å¡Š -->
<div id="pwa-tip" class="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:bottom-4 bg-white dark:bg-gray-800 border dark:border-gray-600 rounded-lg shadow-lg p-4 z-50 flex items-start space-x-3 text-sm text-gray-700 dark:text-gray-200 hidden">
  <div class="text-xl">ğŸ“²</div>
  <div class="flex-1">
    <p class="mb-1 font-semibold">å°‡æ­¤æ‡‰ç”¨åŠ å…¥ä¸»ç•«é¢</p>
    <ul class="list-disc list-inside">
      <li>é»æ“Šç€è¦½å™¨é¸å–®ï¼ˆâ‹® æˆ– âŒµï¼‰</li>
	  <li>iPhone:ã€Œåˆ†äº«ã€åœ–ç¤ºï¼ˆæ–¹æ¡† + â†‘ï¼‰</li>
      <li>é¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€æˆ–ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€</li>
    </ul>
  </div>
  <button onclick="document.getElementById('pwa-tip').remove()" class="ml-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">âœ–</button>
</div>


<script>
  window.addEventListener('load', () => {
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    if (isMobile && !isStandalone) {
      const tip = document.getElementById('pwa-tip');
      if (tip) tip.classList.remove('hidden');
    }
  });
</script>

</body>
</html>
